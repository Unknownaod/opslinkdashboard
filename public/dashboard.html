<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Server Dashboard • Discord Analytics</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>
<body class="min-h-screen bg-gradient-to-br from-black via-zinc-900 to-black text-white font-sans">

<!-- NAVBAR -->
<nav class="flex items-center justify-between px-10 py-6 border-b border-zinc-800">
  <div class="text-xl font-semibold tracking-wide">Discord Analytics</div>
  <div class="flex items-center gap-8 text-sm text-zinc-300">
    <a href="/guilds.html" class="hover:text-white">Servers</a>
    <a href="/" class="hover:text-white">Home</a>
  </div>
</nav>

<!-- DASHBOARD -->
<section class="px-10 py-10 max-w-7xl mx-auto">

  <!-- HEADER -->
  <div class="flex items-center gap-6 mb-6">
    <img id="serverIcon" class="w-20 h-20 rounded-xl border border-zinc-700 bg-zinc-800" />
    <div>
      <h1 id="serverName" class="text-4xl font-bold tracking-tight">Loading…</h1>
      <p class="text-zinc-400 text-sm">Live analytics & activity tracking</p>
    </div>
  </div>

  <!-- TIME SWITCH -->
  <div class="flex gap-4 mb-6">
    <button class="time-btn px-4 py-2 rounded bg-zinc-800" data-window="24h">24h</button>
    <button class="time-btn px-4 py-2 rounded bg-zinc-800" data-window="7d">7d</button>
    <button class="time-btn px-4 py-2 rounded bg-zinc-800" data-window="30d">30d</button>
    <button class="time-btn px-4 py-2 rounded bg-zinc-800" data-window="overall">Overall</button>
  </div>

  <!-- OVERVIEW CARDS -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-10">

    <div class="stat">
      <p class="label">Members</p>
      <p id="membersTotal" class="value">0</p>
      <p class="sub">
        Humans <span id="membersHumans">0</span> · Bots <span id="membersBots">0</span>
      </p>
    </div>

    <div class="stat">
      <p class="label">Presence</p>
      <p class="value">
        <span id="membersOnline">0</span> online
      </p>
      <p class="sub">
        Idle <span id="membersIdle">0</span> · DND <span id="membersDND">0</span> · Offline <span id="membersOffline">0</span>
      </p>
    </div>

    <div class="stat">
      <p class="label">Boosts</p>
      <p id="serverBoosts" class="value">0</p>
      <p class="sub">Server boosts</p>
    </div>

    <div class="stat">
      <p class="label">Polling</p>
      <p class="value text-emerald-400">Live</p>
      <p class="sub">Updates every 20s</p>
    </div>

  </div>

  <!-- TOP LISTS -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-10">

    <div class="card">
      <h2 class="title">Top Members (Messages)</h2>
      <ol id="topMembers" class="list-decimal list-inside space-y-1 text-sm text-zinc-300"></ol>
    </div>

    <div class="card">
      <h2 class="title">Top Channels</h2>
      <ol id="topChannels" class="list-decimal list-inside space-y-1 text-sm text-zinc-300"></ol>
    </div>

    <div class="card">
      <h2 class="title">Top Emojis</h2>
      <ol id="topEmojis" class="list-decimal list-inside space-y-1 text-sm text-zinc-300"></ol>
    </div>

    <div class="card">
      <h2 class="title">Top Voice Activity</h2>
      <ol id="topVoice" class="list-decimal list-inside space-y-1 text-sm text-zinc-300"></ol>
    </div>

  </div>

  <!-- CHARTS -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-10">

    <div class="card h-80">
      <h2 class="title">Messages per Member</h2>
      <canvas id="msgChart"></canvas>
    </div>

    <div class="card h-80">
      <h2 class="title">Presence Distribution</h2>
      <canvas id="presenceChart"></canvas>
    </div>

  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-10">

    <div class="card h-80">
      <h2 class="title">Joins / Leaves</h2>
      <canvas id="joinLeaveChart"></canvas>
    </div>

    <div class="card h-80">
      <h2 class="title">Server Boosts Timeline</h2>
      <canvas id="boostChart"></canvas>
    </div>

  </div>

</section>

<footer class="px-10 py-8 border-t border-zinc-800 text-xs text-zinc-500 flex justify-between">
  <span>© 2026 Discord Analytics</span>
  <span>Not affiliated with Discord</span>
</footer>

<!-- STYLES -->
<style>
.stat {
  padding: 1.25rem;
  border-radius: 0.75rem;
  border: 1px solid #27272a;
  background: rgba(24,24,27,0.6);
}
.stat .label { font-size: .75rem; text-transform: uppercase; letter-spacing: .08em; color: #a1a1aa; }
.stat .value { font-size: 2rem; font-weight: 700; }
.stat .sub { font-size: .75rem; color: #71717a; }

.card {
  padding: 1.25rem;
  border-radius: 0.75rem;
  border: 1px solid #27272a;
  background: rgba(24,24,27,0.6);
}
.card .title { font-weight: 600; margin-bottom: .75rem; }
</style>

<!-- SCRIPT -->
<script>
const params = new URLSearchParams(window.location.search);
const guildId = params.get("guildId");
let currentWindow = "24h";

let cachedData = null;
let isFetching = false;

let msgChart, presenceChart, joinLeaveChart, boostChart;

const el = id => document.getElementById(id);

async function fetchData(force = false) {
  if (!guildId) {
    location.href = "/guilds.html";
    return;
  }

  if (cachedData && !force) return cachedData;
  if (isFetching) return cachedData;

  isFetching = true;
  try {
    const res = await fetch(`/api/servers/${guildId}/analytics`);
    if (!res.ok) throw new Error("API failed");
    cachedData = await res.json();
    return cachedData;
  } catch (err) {
    console.error("Analytics fetch error:", err);
    return cachedData;
  } finally {
    isFetching = false;
  }
}

function fillList(id, items, format) {
  const list = el(id);
  list.innerHTML = "";

  if (!items?.length) {
    list.innerHTML = "<li class='text-zinc-500'>No data</li>";
    return;
  }

  for (const item of items) {
    const li = document.createElement("li");
    li.textContent = format(item);
    list.appendChild(li);
  }
}

function renderCharts(data) {
  const timeline = data.timeline[currentWindow];

  // Messages
  msgChart?.destroy();
  msgChart = new Chart(el("msgChart"), {
    type: "bar",
    data: {
      labels: data.topMembers.map(m => m.username),
      datasets: [{
        data: data.topMembers.map(m => m.count),
        backgroundColor: "rgba(59,130,246,0.7)"
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } }
    }
  });

  // Presence
  presenceChart?.destroy();
  presenceChart = new Chart(el("presenceChart"), {
    type: "doughnut",
    data: {
      labels: ["Online", "Idle", "DND", "Offline"],
      datasets: [{
        data: [
          data.overview.online,
          data.overview.idle,
          data.overview.dnd,
          data.overview.offline
        ],
        backgroundColor: ["#10B981", "#FACC15", "#F87171", "#6B7280"]
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { labels: { color: "#fff" } } }
    }
  });

  // Joins / Leaves
  joinLeaveChart?.destroy();
  joinLeaveChart = new Chart(el("joinLeaveChart"), {
    type: "line",
    data: {
      labels: timeline.labels,
      datasets: [
        {
          label: "Joins",
          data: timeline.joins,
          borderColor: "#10B981",
          backgroundColor: "rgba(16,185,129,0.3)",
          tension: 0.3
        },
        {
          label: "Leaves",
          data: timeline.leaves,
          borderColor: "#F87171",
          backgroundColor: "rgba(248,113,113,0.3)",
          tension: 0.3
        }
      ]
    },
    options: { responsive: true, maintainAspectRatio: false }
  });

  // Boosts
  boostChart?.destroy();
  boostChart = new Chart(el("boostChart"), {
    type: "line",
    data: {
      labels: timeline.labels,
      datasets: [{
        label: "Boosts",
        data: timeline.boosts,
        borderColor: "#3B82F6",
        backgroundColor: "rgba(59,130,246,0.3)",
        tension: 0.3
      }]
    },
    options: { responsive: true, maintainAspectRatio: false }
  });
}

async function render(forceFetch = false) {
  const data = await fetchData(forceFetch);
  if (!data) return;

  const o = data.overview;

  el("serverName").textContent = o.name;
  el("serverIcon").src = o.iconURL || "https://cdn.discordapp.com/embed/avatars/0.png";

  el("membersTotal").textContent = o.members;
  el("membersHumans").textContent = o.humans;
  el("membersBots").textContent = o.bots;
  el("membersOnline").textContent = o.online;
  el("membersIdle").textContent = o.idle;
  el("membersDND").textContent = o.dnd;
  el("membersOffline").textContent = o.offline;
  el("serverBoosts").textContent = o.boosts;

  fillList("topMembers", data.topMembers, m => `${m.username} (${m.count})`);
  fillList("topChannels", data.topChannels, c => `${c.name} (${c.count})`);
  fillList("topEmojis", data.topEmojis, e => `${e.emoji} (${e.count})`);
  fillList("topVoice", data.topVoice, v => `${v.username} (${v.count})`);

  renderCharts(data);
}

// Time buttons (NO refetch)
document.querySelectorAll(".time-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    currentWindow = btn.dataset.window;
    render(false);
  });
});

// Initial load + live refresh
render(true);
setInterval(() => render(true), 20000);
</script>



</body>
</html>
