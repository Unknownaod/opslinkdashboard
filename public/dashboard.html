<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Server Dashboard • Discord Analytics</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>
<body class="min-h-screen bg-gradient-to-br from-black via-zinc-900 to-black text-white font-sans">

<!-- NAVBAR -->
<nav class="flex items-center justify-between px-10 py-6 border-b border-zinc-800">
  <div class="text-xl font-semibold tracking-wide">Discord Analytics</div>
  <div class="flex items-center gap-8 text-sm text-zinc-300">
    <a href="/guilds.html" class="hover:text-white">Servers</a>
    <a href="/" class="hover:text-white">Home</a>
  </div>
</nav>

<!-- DASHBOARD -->
<section class="px-10 py-10 max-w-7xl mx-auto">

  <!-- HEADER -->
  <div class="flex items-center gap-6 mb-6">
    <img id="serverIcon" class="w-20 h-20 rounded-xl border border-zinc-700 bg-zinc-800" />
    <div>
      <h1 id="serverName" class="text-4xl font-bold tracking-tight">Loading…</h1>
      <p class="text-zinc-400 text-sm">Live analytics & activity tracking</p>
    </div>
  </div>

  <!-- TIME SWITCH -->
  <div class="flex gap-4 mb-6">
    <button class="time-btn px-4 py-2 rounded bg-zinc-800" data-window="24h">24h</button>
    <button class="time-btn px-4 py-2 rounded bg-zinc-800" data-window="7d">7d</button>
    <button class="time-btn px-4 py-2 rounded bg-zinc-800" data-window="30d">30d</button>
    <button class="time-btn px-4 py-2 rounded bg-zinc-800" data-window="overall">Overall</button>
  </div>

  <!-- OVERVIEW CARDS -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-10">

    <div class="stat">
      <p class="label">Members</p>
      <p id="membersTotal" class="value">0</p>
      <p class="sub">
        Humans <span id="membersHumans">0</span> · Bots <span id="membersBots">0</span>
      </p>
    </div>

    <div class="stat">
      <p class="label">Presence</p>
      <p class="value">
        <span id="membersOnline">0</span> online
      </p>
      <p class="sub">
        Idle <span id="membersIdle">0</span> · DND <span id="membersDND">0</span> · Offline <span id="membersOffline">0</span>
      </p>
    </div>

    <div class="stat">
      <p class="label">Boosts</p>
      <p id="serverBoosts" class="value">0</p>
      <p class="sub">Server boosts</p>
    </div>

    <div class="stat">
      <p class="label">Polling</p>
      <p class="value text-emerald-400">Live</p>
      <p class="sub">Updates every 20s</p>
    </div>

  </div>

  <!-- TOP LISTS -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-10">

    <div class="card">
      <h2 class="title">Top Members (Messages)</h2>
      <ol id="topMembers" class="list-decimal list-inside space-y-1 text-sm text-zinc-300"></ol>
    </div>

    <div class="card">
      <h2 class="title">Top Channels</h2>
      <ol id="topChannels" class="list-decimal list-inside space-y-1 text-sm text-zinc-300"></ol>
    </div>

    <div class="card">
      <h2 class="title">Top Emojis</h2>
      <ol id="topEmojis" class="list-decimal list-inside space-y-1 text-sm text-zinc-300"></ol>
    </div>

    <div class="card">
      <h2 class="title">Top Voice Activity</h2>
      <ol id="topVoice" class="list-decimal list-inside space-y-1 text-sm text-zinc-300"></ol>
    </div>

  </div>

  <!-- CHARTS -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-10">

    <div class="card h-80">
      <h2 class="title">Messages per Member</h2>
      <canvas id="msgChart"></canvas>
    </div>

    <div class="card h-80">
      <h2 class="title">Presence Distribution</h2>
      <canvas id="presenceChart"></canvas>
    </div>

  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-10">

    <div class="card h-80">
      <h2 class="title">Joins / Leaves</h2>
      <canvas id="joinLeaveChart"></canvas>
    </div>

    <div class="card h-80">
      <h2 class="title">Server Boosts Timeline</h2>
      <canvas id="boostChart"></canvas>
    </div>

  </div>

</section>

<footer class="px-10 py-8 border-t border-zinc-800 text-xs text-zinc-500 flex justify-between">
  <span>© 2026 Discord Analytics</span>
  <span>Not affiliated with Discord</span>
</footer>

<!-- STYLES -->
<style>
.stat {
  padding: 1.25rem;
  border-radius: 0.75rem;
  border: 1px solid #27272a;
  background: rgba(24,24,27,0.6);
}
.stat .label { font-size: .75rem; text-transform: uppercase; letter-spacing: .08em; color: #a1a1aa; }
.stat .value { font-size: 2rem; font-weight: 700; }
.stat .sub { font-size: .75rem; color: #71717a; }

.card {
  padding: 1.25rem;
  border-radius: 0.75rem;
  border: 1px solid #27272a;
  background: rgba(24,24,27,0.6);
}
.card .title { font-weight: 600; margin-bottom: .75rem; }
</style>

<!-- SCRIPT -->
<script>
const params = new URLSearchParams(window.location.search);
const guildId = params.get("guildId");
let currentWindow = "24h";

let msgChart, presenceChart, joinLeaveChart, boostChart;
let previousData = null;

async function fetchData() {
  if (!guildId) return location.href = "/guilds.html";
  const res = await fetch(`/api/servers/${guildId}/analytics`);
  if (!res.ok) throw new Error("Fetch failed");
  return res.json();
}

function fillList(id, items, format) {
  const el = document.getElementById(id);
  el.innerHTML = "";
  if (!items?.length) {
    el.innerHTML = "<li class='text-zinc-500'>No data</li>";
    return;
  }
  const fragment = document.createDocumentFragment();
  items.forEach(i => {
    const li = document.createElement("li");
    li.textContent = format(i);
    fragment.appendChild(li);
  });
  el.appendChild(fragment);
}

function updateChart(chart, labels, datasets) {
  if (!chart) return null;
  chart.data.labels = labels;
  datasets.forEach((ds, i) => {
    chart.data.datasets[i].data = ds.data;
  });
  chart.update();
  return chart;
}

function renderCharts(data) {
  // Messages chart
  if (!msgChart) {
    msgChart = new Chart(document.getElementById("msgChart"), {
      type: "bar",
      data: { labels: data.topMembers.map(m => m.username), datasets: [{ data: data.topMembers.map(m => m.count), backgroundColor:'rgba(59,130,246,0.7)' }] },
      options: { plugins:{ legend:{ display:false } }, responsive:true, maintainAspectRatio:false }
    });
  } else {
    updateChart(msgChart, data.topMembers.map(m => m.username), [{ data: data.topMembers.map(m => m.count) }]);
  }

  // Presence chart
  const presenceData = [data.overview.online, data.overview.idle, data.overview.dnd, data.overview.offline];
  if (!presenceChart) {
    presenceChart = new Chart(document.getElementById("presenceChart"), {
      type: "doughnut",
      data: { labels: ["Online","Idle","DND","Offline"], datasets:[{ data: presenceData, backgroundColor:['#10B981','#FACC15','#F87171','#6B7280'] }] },
      options: { plugins:{ legend:{ labels:{ color:'#fff' } } }, responsive:true, maintainAspectRatio:false }
    });
  } else {
    updateChart(presenceChart, ["Online","Idle","DND","Offline"], [{ data: presenceData }]);
  }

  // Timeline charts
  const timeline = data.timeline[currentWindow];

  if (!joinLeaveChart) {
    joinLeaveChart = new Chart(document.getElementById("joinLeaveChart"), {
      type:'line',
      data: { labels: timeline.labels, datasets:[
        { label:'Joins', data: timeline.joins, borderColor:'#10B981', backgroundColor:'rgba(16,185,129,0.3)' },
        { label:'Leaves', data: timeline.leaves, borderColor:'#F87171', backgroundColor:'rgba(248,113,113,0.3)' }
      ] },
      options:{ responsive:true, maintainAspectRatio:false }
    });
  } else {
    updateChart(joinLeaveChart, timeline.labels, [
      { data: timeline.joins },
      { data: timeline.leaves }
    ]);
  }

  if (!boostChart) {
    boostChart = new Chart(document.getElementById("boostChart"), {
      type:'line',
      data: { labels: timeline.labels, datasets:[{ label:'Boosts', data: timeline.boosts, borderColor:'#3B82F6', backgroundColor:'rgba(59,130,246,0.3)' }] },
      options:{ responsive:true, maintainAspectRatio:false }
    });
  } else {
    updateChart(boostChart, timeline.labels, [{ data: timeline.boosts }]);
  }
}

async function render() {
  try {
    const data = await fetchData();

    // Only update overview if changed
    if (!previousData || JSON.stringify(previousData.overview) !== JSON.stringify(data.overview)) {
      const o = data.overview;
      document.getElementById("serverName").textContent = o.name;
      document.getElementById("serverIcon").src = o.iconURL || "https://cdn.discordapp.com/embed/avatars/0.png";

      membersTotal.textContent = o.members;
      membersHumans.textContent = o.humans;
      membersBots.textContent = o.bots;
      membersOnline.textContent = o.online;
      membersIdle.textContent = o.idle;
      membersDND.textContent = o.dnd;
      membersOffline.textContent = o.offline;
      serverBoosts.textContent = o.boosts;
    }

    // Update lists if changed
    fillList("topMembers", data.topMembers, m => `${m.username} (${m.count})`);
    fillList("topChannels", data.topChannels, c => `${c.name} (${c.count})`);
    fillList("topEmojis", data.topEmojis, e => `${e.emoji} (${e.count})`);
    fillList("topVoice", data.topVoice, v => `${v.username} (${v.count})`);

    // Update charts
    renderCharts(data);

    previousData = data;
  } catch(err) {
    console.error("Render error:", err);
  }
}

// Time window buttons
document.querySelectorAll(".time-btn").forEach(btn => {
  btn.addEventListener("click", e => {
    currentWindow = e.target.dataset.window;
    render();
  });
});

// Initial render + live updates
render();
setInterval(render, 20000);
</script>


</body>
</html>
