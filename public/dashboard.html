<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Server Dashboard • Discord Analytics</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-black via-zinc-900 to-black text-white overflow-x-hidden font-sans">

<!-- NAVBAR -->
<nav class="flex items-center justify-between px-10 py-6 border-b border-zinc-800">
  <div class="text-xl font-semibold tracking-wide">Discord Analytics</div>
  <div class="flex items-center gap-8 text-sm">
    <a href="/guilds.html" class="hover:opacity-80">Servers</a>
    <a href="/" class="hover:opacity-80">Home</a>
  </div>
</nav>

<!-- DASHBOARD -->
<section class="px-10 py-10 max-w-6xl mx-auto">
  <!-- Header -->
  <div class="flex items-center gap-6 mb-6">
    <img id="serverIcon" src="" class="w-20 h-20 rounded-lg border border-zinc-700" alt="Server Icon">
    <div>
      <h1 id="serverName" class="text-4xl font-bold">Loading...</h1>
      <p id="serverDesc" class="text-zinc-400"></p>
      <a id="serverInvite" href="#" target="_blank" class="text-blue-400 underline">Join Server</a>
    </div>
  </div>

  <!-- STATUS CARDS -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
    <div class="p-4 rounded border border-zinc-700 bg-zinc-900/50">
      <h2 class="font-semibold mb-2">Members</h2>
      <p id="membersTotal">0</p>
      <p class="text-sm text-zinc-400">
        Humans: <span id="membersHumans">0</span> | Bots: <span id="membersBots">0</span>
      </p>
      <p class="text-sm text-zinc-400">
        Online: <span id="membersOnline">0</span> | Idle: <span id="membersIdle">0</span> | DND: <span id="membersDND">0</span> | Offline: <span id="membersOffline">0</span>
      </p>
      <p class="text-sm text-zinc-400">
        Joins: <span id="membersJoins">0</span> | Leaves: <span id="membersLeaves">0</span>
      </p>
    </div>
    <div class="p-4 rounded border border-zinc-700 bg-zinc-900/50">
      <h2 class="font-semibold mb-2">Channels & Boosts</h2>
      <p>Text: <span id="channelsText">0</span> | Voice: <span id="channelsVoice">0</span></p>
      <p>Categories: <span id="channelsCat">0</span> | Threads: <span id="channelsThreads">0</span></p>
      <p>Boosts: <span id="serverBoosts">0</span></p>
    </div>
    <div class="p-4 rounded border border-zinc-700 bg-zinc-900/50">
      <h2 class="font-semibold mb-2">Top Members</h2>
      <ol id="topMembers" class="list-decimal list-inside text-sm text-zinc-300 max-h-64 overflow-y-auto"></ol>
    </div>
  </div>

  <!-- Top Channels & Emojis -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
    <div class="p-4 rounded border border-zinc-700 bg-zinc-900/50">
      <h2 class="font-semibold mb-2">Top Channels</h2>
      <ol id="topChannels" class="list-decimal list-inside text-sm text-zinc-300 max-h-64 overflow-y-auto"></ol>
    </div>
    <div class="p-4 rounded border border-zinc-700 bg-zinc-900/50">
      <h2 class="font-semibold mb-2">Top Emojis</h2>
      <ol id="topEmojis" class="list-decimal list-inside text-sm text-zinc-300 max-h-64 overflow-y-auto"></ol>
    </div>
  </div>

  <!-- Charts -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
    <div class="p-4 rounded border border-zinc-700 bg-zinc-900/50">
      <h2 class="font-semibold mb-2">Messages per Member</h2>
      <canvas id="msgChart"></canvas>
    </div>
    <div class="p-4 rounded border border-zinc-700 bg-zinc-900/50">
      <h2 class="font-semibold mb-2">Presence Distribution</h2>
      <canvas id="presenceChart"></canvas>
    </div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
    <div class="p-4 rounded border border-zinc-700 bg-zinc-900/50">
      <h2 class="font-semibold mb-2">Roles Usage</h2>
      <canvas id="rolesChart"></canvas>
    </div>
    <div class="p-4 rounded border border-zinc-700 bg-zinc-900/50">
      <h2 class="font-semibold mb-2">Voice Channels Usage</h2>
      <canvas id="voiceChart"></canvas>
    </div>
  </div>

  <!-- Comments -->
  <div class="p-4 rounded border border-zinc-700 bg-zinc-900/50 mb-6">
    <h2 class="font-semibold mb-2">Recent Comments / Events</h2>
    <div id="commentsContainer" class="flex flex-col gap-3 max-h-64 overflow-y-auto"></div>
  </div>
</section>

<footer class="px-10 py-10 border-t border-zinc-800 text-sm text-zinc-400 flex justify-between">
  <span>© 2026 Discord Analytics</span>
  <span>Not affiliated with Discord</span>
</footer>

<script>
const params = new URLSearchParams(window.location.search);
const guildId = params.get('guildId');

let msgChart, presenceChart, rolesChart, voiceChart;

async function fetchData() {
  try {
    if(!guildId) return window.location.href = '/guilds.html';
    const res = await fetch(`/api/servers/${guildId}/analytics`);
    if(!res.ok) throw new Error('Failed to fetch analytics');
    const data = await res.json();
    renderDashboard(data);
  } catch(err) {
    console.error(err);
    alert('Failed to load dashboard data.');
  }
}

function renderDashboard(data) {
  const o = data.overview;

  // Header
  document.getElementById('serverName').textContent = o.name;
  document.getElementById('serverIcon').src = o.icon || 'https://cdn.discordapp.com/embed/avatars/0.png';
  document.getElementById('serverDesc').textContent = o.description || '';
  document.getElementById('serverInvite').href = o.invite || '#';

  // Members
  document.getElementById('membersTotal').textContent = o.members;
  document.getElementById('membersHumans').textContent = o.humans;
  document.getElementById('membersBots').textContent = o.bots;
  document.getElementById('membersOnline').textContent = o.online;
  document.getElementById('membersIdle').textContent = o.idle;
  document.getElementById('membersDND').textContent = o.dnd;
  document.getElementById('membersOffline').textContent = o.offline;
  document.getElementById('membersJoins').textContent = o.joins || 0;
  document.getElementById('membersLeaves').textContent = o.leaves || 0;

  // Channels
  document.getElementById('channelsText').textContent = o.channels.text || 0;
  document.getElementById('channelsVoice').textContent = o.channels.voice || 0;
  document.getElementById('channelsCat').textContent = o.channels.categories || 0;
  document.getElementById('channelsThreads').textContent = o.channels.threads || 0;
  document.getElementById('serverBoosts').textContent = o.boosts || 0;

  // Top Lists
  fillList('topMembers', data.topMembers, 'member');
  fillList('topChannels', data.topChannels, 'channel');
  fillList('topEmojis', data.topEmojis, 'emoji');

  // Charts
  renderCharts(data);
}

function fillList(id, items, type){
  const el = document.getElementById(id);
  el.innerHTML = '';
  if(!items?.length) return el.innerHTML = '<li class="text-zinc-400">No data</li>';
  items.forEach(item => {
    const li = document.createElement('li');
    li.textContent = type==='member'?`${item.username} (${item.count})`
                    :type==='channel'?`${item.name} (${item.count})`
                    :type==='emoji'?`${item.emoji} (${item.count})`:JSON.stringify(item);
    el.appendChild(li);
  });
}

function renderCharts(data){
  const membersLabels = data.topMembers.map(m=>m.username);
  const membersValues = data.topMembers.map(m=>m.count);

  const presenceData = [data.overview.online, data.overview.idle, data.overview.dnd, data.overview.offline];

  // Messages per member
  if(msgChart) msgChart.destroy();
  msgChart = new Chart(document.getElementById('msgChart'), {
    type:'bar',
    data:{
      labels: membersLabels,
      datasets:[{label:'Messages', data:membersValues, backgroundColor:'rgba(59,130,246,0.7)'}]
    },
    options:{plugins:{legend:{display:false}}, responsive:true}
  });

  // Presence
  if(presenceChart) presenceChart.destroy();
  presenceChart = new Chart(document.getElementById('presenceChart'),{
    type:'doughnut',
    data:{
      labels:['Online','Idle','DND','Offline'],
      datasets:[{data:presenceData, backgroundColor:['#10B981','#FACC15','#F87171','#6B7280']}]
    }
  });

  // Optional: Roles & Voice Channels if data available
  if(data.topRoles){
    const roleLabels = data.topRoles.map(r=>r.name);
    const roleValues = data.topRoles.map(r=>r.count);
    if(rolesChart) rolesChart.destroy();
    rolesChart = new Chart(document.getElementById('rolesChart'),{
      type:'bar',
      data:{labels:roleLabels,datasets:[{label:'Members',data:roleValues,backgroundColor:'rgba(139,92,246,0.7)'}]},
      options:{plugins:{legend:{display:false}}, responsive:true}
    });
  }
  if(data.topVoiceChannels){
    const voiceLabels = data.topVoiceChannels.map(v=>v.name);
    const voiceValues = data.topVoiceChannels.map(v=>v.count);
    if(voiceChart) voiceChart.destroy();
    voiceChart = new Chart(document.getElementById('voiceChart'),{
      type:'bar',
      data:{labels:voiceLabels,datasets:[{label:'Users',data:voiceValues,backgroundColor:'rgba(6,182,212,0.7)'}]},
      options:{plugins:{legend:{display:false}}, responsive:true}
    });
  }

  // Comments / Events
  const commentsContainer = document.getElementById('commentsContainer');
  commentsContainer.innerHTML = '';
  (data.events||[]).slice(-10).forEach(ev=>{
    const div = document.createElement('div');
    div.className='p-2 border-b border-zinc-700';
    div.textContent = `[${new Date(ev.timestamp).toLocaleString()}] ${ev.type} by ${ev.data?.userId||'N/A'}`;
    commentsContainer.appendChild(div);
  });
}

fetchData();
setInterval(fetchData,20000);
</script>
</body>
</html>
